// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AgentName {
  JIM
  ALEX
  MIKE
  TONY
  LARA
  VALENTINA
  DANIELE
  SIMONE
  NIKO
  ALADINO
  LAURA
  DAN
  MAX
  SOFIA
  ROBERTA

  // --- test agents ---
  TEST_JIM
  TEST_ALEX
  TEST_MIKE
  TEST_TONY
  TEST_LARA
  TEST_VALENTINA
  TEST_DANIELE
  TEST_SIMONE
  TEST_NIKO
  TEST_ALADINO
  TEST_LAURA
  TEST_DAN
  TEST_MAX
  TEST_SOFIA
  TEST_ROBERTA
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  oauthId   String   @unique
  username  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Per-agent assignments with timing & expiry
  agents AssignedAgent[]
  // Per-group assignments with timing & expiry
  groups AssignedGroup[]
  // User conversations
  conversations Conversation[]
}

model AssignedAgent {
  id        String    @id @default(uuid())
  userId    String
  agentName AgentName

  // When access starts (defaults now) and when it expires
  startsAt     DateTime  @default(now())
  expiresAt    DateTime?
  durationDays Int?

  // Only one active assignment per (user, agent)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, agentName, isActive], map: "uniq_active_agent_per_user")
  @@index([userId, isActive])
  @@index([expiresAt])
}

model AgentGroup {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)

  items       AgentGroupItem[]
  assignments AssignedGroup[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model AgentGroupItem {
  id        String    @id @default(uuid())
  groupId   String
  agentName AgentName

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group AgentGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, agentName], map: "uniq_agent_per_group")
  @@index([groupId])
}

model AssignedGroup {
  id      String @id @default(uuid())
  userId  String
  groupId String

  startsAt     DateTime  @default(now())
  expiresAt    DateTime?
  durationDays Int?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  group AgentGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId, isActive], map: "uniq_active_group_per_user")
  @@index([userId, isActive])
  @@index([groupId])
  @@index([expiresAt])
}

// ─────────────────────────────────────────────────────────────
// Conversation & Message Models
// ─────────────────────────────────────────────────────────────

model Conversation {
  id          String    @id // e.g., "chat_1765435414978"
  userId      String
  title       String
  agentId     String    // e.g., "daniele-ai"
  sessionId   String    // e.g., "session_1765435414978_zpwb22b"
  folderId    String?
  archived    Boolean   @default(false)
  lastUpdated DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  messages Message[]
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([agentId])
  @@index([archived])
  @@index([lastUpdated])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  text           String
  sender         String   // "ai" or "user"
  time           String   // e.g., "12:43"
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}
